{% extends "site_base.html" %}
{% load i18n %}

{% block extra_head %}
<style>
body{ margin-top:20px; font-size: 14px}
.glyphicon { margin-right:5px;}
.section-box h2 { margin-top:0px;}
.section-box h2 a { font-size:15px; }
.glyphicon-heart { color:#e74c3c;}
.glyphicon-comment { color:#27ae60;}
.separator { padding-right:5px;padding-left:5px; }
.section-box hr {margin-top: 0;margin-bottom: 5px;border: 0;border-top: 1px solid rgb(199, 199, 199);}
.import-options-form .form-group {margin-bottom:4px;}
.clrs-red {color:#FF4136;}
.user-data-metadata {font-size: 12px;}
.user-data-story-layers-list {font-size: 13px;}
.user-data-story-layer-actions {font-size: 13px;}
.import-button {margin: 10px;}
.light-bold {font-weight: 600;}
.import-title{font-size: 14px;}
.section-box-subtitle {margin-top: -4px;}
.import-head {cursor: pointer;}
.import-options {margin-left: 15px;}
.importer-layer-name {word-wrap: break-word;}
</style>
{% endblock %}

{% block extra_script %}
<script type="text/javascript" src="{{STATIC_URL}}lib/js/angular.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}importer/importer.js"></script>
{{ block.super }}
{% endblock %}

{% block body_outer %}

<div class="page-header">
  <a href="{% url 'uploads-new' %}"><div class="pull-right" style="margin-top: 25px; font-size: 14px"><i class="fa fa-long-arrow-left"></i> Add Data</div></a>
  <h2 class="page-title">{% trans "Manage your data" %}</h2>
</div>

<div class="container" ng-app="mapstory.uploader" ng-controller="uploadList">
    <div class="row">
        <div class="col-md-8">
            {% for upload in object_list %}
            <div class="well well-sm" style="border-radius: 0">
            <div class="row upload" ng-cloak uploadid="{{upload.id}}" >
                    <div class="col-xs-12 col-md-12 section-box">
                        <div class="import-head" ng-click="showDetails=!showDetails">
                            <div class="import-title light-bold">
                                {{ upload.uploadfile_set.first.name }}
                                <span class="pull-right"><i ng-show="'{{upload.all_layers_imported}}' === 'True'" class="fa fa-check pull-right" style="color:#3D9970;"></i></span>
                            </div>
                            <div class="section-box-subtitle">
                                <div class="user-data-metadata">
                                        {{upload.date|date:"F d Y"}}
                                        <span class="pull-right">{{upload.filesize}}</span>
                                    </div>
                            </div>
                        </div>

                        <i ng-show="hasError" class="fa fa-times pull-right" style="color:#FF4136;"></i>
                        <div class="row" ng-show="showDetails">
                            <div class="col-md-12">
                                <hr style="margin-top: 10px"/>
                                {% if upload.any_layers_imported %}
                                <div><span class="light-bold">Story Layers:</span>
                                    <ul class="user-data-story-layers-list">
                                    {% for uploaded_layer in upload.uploadlayer_set.all %}
                                       {% if uploaded_layer.layer %}
                                        <li><a href="{{ uploaded_layer.layer.get_absolute_url }}">{{ uploaded_layer.layer.name }}</a></li>
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                {% if not upload.all_layers_imported %}
                                <br/>
                                <div class="light-bold" ng-click="showImportOptions=!showImportOptions; getFields({{upload.id}})" style="cursor: pointer"><i class="fa fa-cog"></i> Create StoryLayer{{upload.uploadeddata_set|pluralize}} from this data</div>

                                <div ng-show="showImportWaiting" style="margin-right: 50%; margin-left: 50%; margin-top: 30px; margin-bottom: 30px">
                                    <i class="fa fa-spinner fa-spin fa-3x"></i>
                                </div>
                                <div class="row col-md-offset-3 import-options" ng-show="showImportOptions">
                                    <div ng-show="!showImportWaiting" ng-repeat="layer in layers" class="layer-in-upload">
                                        <!--<div ng-show="layer.imported_layer">
                                            <span><b>Story Layer:</b> </span><a href="{[layer.imported_layer.url]}">{[layer.imported_layer.name]}</a>
                                        </div>-->
                                        <form name="importOptionsForm" class="form-horizontal import-options-form" ng-show="!layer.imported_layer">
                                            <!--
                                            <div class="col-md-2">Layer {[$index+1]}:</div>-->
                                            <!-- TODO
                                            <div class="form-group">
                                                <label for="name" class="col-sm-4 control-label">Story Layer Name</label>
                                                <input id="name" type="text" ng-model="importOptions.name">
                                            </div>
                                            -->
                                            <div class="col-md-12">
                                                <br/>
                                                <div class="form-group">
                                                    <label for="layerName" class="col-sm-4 control-label">Layer Name:</label>
                                                    <input id="layerName" type="text" class="col-md-5" ng-model="importOptions.layerName" placeholder="{[layer.name]}">
                                                </div>
                                                <div class="form-group">
                                                    <label for="configureTime" class="col-sm-4 control-label">Enable time</label>
                                                    <input id="configureTime" type="checkbox" ng-model="importOptions.configureTime" checked>
                                                </div>
                                                    <div ng-show="importOptions.configureTime">
                                                            <div class="form-group">
                                                                <label for="start_date" class="col-sm-4 control-label">Start date:</label>
                                                                <select ng-model="importOptions.start_date" class="col-md-5" id="start_date" ng-required='importOptions.configureTime'>
                                                                    <option ng-repeat="option in layer.fields" value="{[option.name]}">{[option.name]}</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="end_date" class="col-sm-4 control-label">End date:</label>
                                                                <select ng-model="importOptions.end_date" class="col-md-5" id="end_date">
                                                                    <option ng-repeat="option in layer.fields" value="{[option.name]}">{[option.name]}</option>
                                                                </select>
                                                            </div>
                                                    </div>
                                                <div class="form-group">
                                                    <label for="editable" class="col-sm-4 control-label">Editable</label>
                                                    <input id="editable" type="checkbox" ng-model="importOptions.editable" checked>
                                                </div>
                                                <div class="form-group" style="margin-left: 50%; margin-right: 50%;">
                                                    <div class="btn btn-default import-button" ng-click="configureUpload('/uploads/configure/' + layer.id, layer.index)" ng-class="{disabled: !importOptionsForm.$valid}">Import <i class="fa" ng-class="{'fa-circle-o-notch fa-spin': configuring, 'fa-arrow-circle-right': !configuring}"></i></div>
                                                </div>
                                         </div>
                                        </form>
                                        <div style="border-bottom-solid: 1px solid gray;"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row" ng-show="showDetails">
                                <div class="col-md-12 user-data-story-layer-actions">
                                    <hr/>
                                    <span class="clrs-red pull-right"><a href="{% url 'uploads-delete' upload.id %}"><i class="fa fa-trash-o"></i> Delete</a></span>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
</div>
{% endblock %}